<template>
    <el-form-item ref="input"
        v-bind:label="computedConfigs.label"
        v-bind:prop="computedConfigs.name"
        v-bind:rules="computedConfigs.rules"
        v-bind:error="inputError"
        v-bind:show-message="true">
        <template slot="label">
            <slot name="label">
                {{ computedConfigs.label + '&nbsp;' }}
            </slot>
        </template>
        <slot name="input">
            <el-radio-group
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-if="computedConfigs.type === 'radio'">
                <el-radio class="radio"
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:name="computedPostName"
                    v-bind:label="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                    {{ each[computedConfigs.labelKey] }}
                </el-radio>
            </el-radio-group>
            <el-checkbox-group
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-bind:min="computedConfigs.min"
                v-bind:max="computedConfigs.max"
                v-else-if="computedConfigs.type === 'checkbox'">
                <el-checkbox
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:name="computedPostName"
                    v-bind:label="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                    {{ each[computedConfigs.labelKey] }}
                </el-checkbox>
            </el-checkbox-group>
            <el-select
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-bind:multiple="computedConfigs.multiple"
                v-bind:multiple-limit="computedConfigs.max"
                v-bind:clearable="computedConfigs.clearable"
                v-bind:loading="loading"
                v-else-if="computedConfigs.type === 'select'">
                <el-option
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:label="each[computedConfigs.labelKey]"
                    v-bind:value="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                </el-option>
            </el-select>
            <el-date-picker
                v-bind:type="computedConfigs.type"
                v-bind:format="computedConfigs.format"
                v-model="inputValue"
                v-bind:editable="false"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type.indexOf('date') === 0">
            </el-date-picker>
            <el-switch
                v-bind:on-text="computedConfigs.onText"
                v-bind:off-text="computedConfigs.offText"
                v-bind:on-value="computedConfigs.onValue"
                v-bind:off-value="computedConfigs.offValue"
                v-bind:on-color="computedConfigs.onColor"
                v-bind:off-color="computedConfigs.offColor"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type === 'switch'">
            </el-switch>
            <el-slider
                v-bind:min="computedConfigs.min"
                v-bind:max="computedConfigs.max"
                v-bind:step="computedConfigs.step"
                v-bind:show-input="computedConfigs.showInput"
                v-bind:show-stops="computedConfigs.showStops"
                v-bind:show-tooltip="computedConfigs.showTooltip"
                v-bind:range="computedConfigs.range"
                v-bind:vertical="computedConfigs.vertical"
                v-bind:height="computedConfigs.height"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type === 'slider'">
            </el-slider>
            <el-input
                v-bind:type="computedConfigs.type"
                v-bind:name="computedPostName"
                v-bind:rows="computedConfigs.rows"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else
            ></el-input>
            <input
                v-for="(input, index) in computedHiddens"
                v-bind:key="index"
                type="hidden"
                v-bind:name="computedPostName"
                v-bind:value="input.split ? inputValue[index] : inputValue"/>
        </slot>
    </el-form-item>
</template>

<script>
    import Vue from 'vue';
    import Element from 'element-ui';
    import ElementDateUtils from 'element-ui/src/utils/date';

    Vue.use(Element);

    export default {
        name: 'nftn-el-input',
        props: {
            label: {
                type: String
            },
            type: {
                type: String,
                default: 'vValue'
            },
            name: {
                type: String
            },
            configs: {
                type: Object,
                default () { return {}; }
            },
            value: { // v-model
                default: ''
            },
            emptyNoPost: {
                type: Boolean,
                default: false
            },
            rules: {
                type: Array,
                default: null
            },
            errors: {
                type: Array,
                default () { return []; }
            },
            disabled: {
                type: Boolean,
                default: false
            },
            // 特殊选项
            datasource: { // type="radio | checkbox | select"
                type: Array,
                default: null
            },
            labelKey: { // type="radio | checkbox | select"
                type: String,
                default: 'name'
            },
            valueKey: { // type="radio | checkbox | select"
                type: String,
                default: 'value'
            },
            rows: { // type='textarea'
                type: Number
            },
            min: { // type='checkbox | slider'
                type: Number
            },
            max: { // type='checkbox | select | slider'
                type: Number
            },
            multiple: { // type='select'
                type: Boolean,
                default: false
            },
            clearable: { // type='select'
                type: Boolean,
                default: true
            },
            format: { // type='date | datetime'
                type: String,
                default: ''
            },
            onText: { // type='switch'
                type: String,
                default: 'ON'
            },
            offText: { // type='switch'
                type: String,
                default: 'OFF'
            },
            onValue: { // type='switch'
                default: true
            },
            offValue: { // type='switch'
                default: false
            },
            onColor: { // type='switch'
                type: String,
                default: '#20A0FF'
            },
            offColor: { // type='switch'
                type: String,
                default: '#C0CCDA'
            },
            step: { // type='switch'
                type: Number,
                default: 1
            },
            showInput: { // type='switch'
                type: Boolean,
                default: false
            },
            showStops: { // type='switch'
                type: Boolean,
                default: false
            },
            showTooltip: { // type='switch'
                type: Boolean,
                default: true
            },
            range: { // type='switch'
                type: Boolean,
                default: false
            },
            vertical: { // type='switch'
                type: Boolean,
                default: false
            },
            height: { // type='switch'
                type: String,
                default: '100px'
            }
        }, // props {}
        computed: {
            computedPostName () {
                let configs = this.computedConfigs;
                let result = configs.name;
                if (this.value === '' && configs.emptyNoPost === true) {
                    result = '';
                }
                return result;
            },
            computedConfigs () {
                let configs = Object.assign({
                    label: this.label,
                    type: this.type,
                    name: this.name,
                    emptyNoPost: this.emptyNoPost,
                    rules: this.rules,
                    errors: this.errors,
                    disabled: this.disabled,
                    datasource: this.datasource,
                    labelKey: this.labelKey,
                    valueKey: this.valueKey,
                    rows: this.rows,
                    min: this.min,
                    max: this.max,
                    multiple: this.multiple,
                    clearable: this.clearable,
                    format: this.format,
                    onText: this.onText,
                    offText: this.offText,
                    onValue: this.onValue,
                    offValue: this.offValue,
                    onColor: this.onColor,
                    offColor: this.offColor,
                    step: this.step,
                    showInput: this.showInput,
                    showStops: this.showStops,
                    showTooltip: this.showTooltip,
                    range: this.range,
                    vertical: this.vertical,
                    height: this.height
                }, this.configs);
                if (configs.type.indexOf('date') === 0) {
                    configs.format = configs.format || (configs.type.indexOf('time') > 0 ? 'yyyy-MM-dd HH:mm' : 'yyyy-MM-dd');
                }
                return configs;
            },
            computedHiddens () {
                let inputs = [];
                let type = this.computedConfigs.type;
                if (['date', 'datetime', 'daterange', 'datetimerange', 'select', 'switch', 'slider'].indexOf(type) !== -1) {
                    let input = { name: this.computedConfigs.name };
                    if (type.indexOf('range') > 0) {
                        input.split = true;
                        inputs.push(input);
                    }
                    inputs.push(input);
                }
                return inputs;
            }
        }, // computed {}
        data () {
            return {
                loading: false,
                inputValue: this.value,
                inputError: ''
            };
        }, // data ()
        watch: {
            computedConfigs: {
                handler (newConfigs, oldConfigs) {
                    // let inputvalue = this.value;
                    let configs = newConfigs;
                    let datasource = configs.datasource;
                    if (datasource instanceof Array && datasource.length) {
                        // 确保数据源数据的结构正确
                        newConfigs.datasource = datasource.map(each => {
                            let result = {};
                            if (typeof each !== 'object') {
                                result[configs.labelKey] = each;
                                result[configs.valueKey] = each;
                            } else {
                                result = each;
                            }
                            return result;
                        });
                    }
                },
                immediate: true
            },
            inputValue (newValue, oldValue) {
                let type = this.computedConfigs.type;
                let value = newValue;
                if (type.indexOf('date') === 0 && value) {
                    let format = this.computedConfigs.format;

                    if (type.indexOf('range') !== -1) {
                        if (value[0] && value[1]) {
                            value = value.map(v => {
                                if (typeof v === 'string') {
                                    v = ElementDateUtils.parse(v, format);
                                }
                                return ElementDateUtils.format(v, format);
                            });
                        }
                    } else {
                        if (typeof value === 'string') {
                            value = ElementDateUtils.parse(value, format);
                        }
                        value = ElementDateUtils.format(value, format);
                    }
                }
                this.$emit('input', value);
            },
            value (newValue, oldValue) {
                if (JSON.stringify(newValue) !== JSON.stringify(oldValue)) {
                    // 由 radio 分开放在两个地方的时候引起数据不响应
                    this.inputValue = null;
                    this.inputValue = newValue;
                }
            }
        }, // watch {}
        created () {},
        mounted () {}
    };
</script>

<style>
    .el-date-editor.el-input {
        width: 100%;
    }
</style>
